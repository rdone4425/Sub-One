# 优选管理功能说明

## 📌 功能概述

优选管理是 Sub-One 的一个新功能模块，允许用户管理和配置优选域名/IP 列表。这些配置可以用于在节点转换时替换服务器地址，以提升访问速度和稳定性。

## 🎯 主要特性

### 1. **创建优选配置**
- 支持创建三种类型的优选配置：
  - **域名优选**：用于替换节点中的域名
  - **IP优选**：用于替换节点中的IP地址
  - **混合优选**：支持域名和IP混合

### 2. **配置范围**
- **全局配置**：所有订阅和节点都使用此配置
- **特定配置**：只应用于指定的订阅

### 3. **灵活的项目列表**
- 每行一条优选项
- 支持注释（以 `#` 开头）
- 自动过滤空行和注释

### 4. **配置管理**
- ✅ **添加**：点击"新增优选"按钮创建新配置
- ✏️ **编辑**：修改现有配置的所有信息
- 🗑️ **删除**：删除不需要的配置
- 🔄 **启用/禁用**：快速切换配置状态

## 📖 使用步骤

### 第一步：进入优选管理
1. 点击左侧菜单栏中的 **"🎯 优选管理"**
2. 系统会显示所有现有的优选配置（如果有的话）

### 第二步：创建新的优选配置

#### 方法一：从列表页面
1. 点击 **"➕ 新增优选"** 按钮
2. 填写配置信息

#### 配置表单说明

| 字段 | 说明 | 示例 |
|------|------|------|
| **配置名称** | 配置的标识名称（必填） | `CDN优选域名` |
| **配置描述** | 用途说明（可选） | `用于快速访问CDN资源` |
| **配置类型** | 优选项的类型（必填） | 域名 / IP / 混合 |
| **配置范围** | 应用范围（全局/特定订阅） | 全局配置 |
| **优选项列表** | 每行一条项目（必填） | 见示例 |

### 第三步：填写优选项

#### 方式一：手动输入 📝

根据不同的配置类型，输入相应的内容：

**域名优选示例：**
```
cdn.example.com
proxy.example.com
fast.example.com # 这是快速节点
```

**IP优选示例：**
```
1.2.3.4
5.6.7.8
9.10.11.12 # 备用IP
```

**混合优选示例：**
```
example.com
1.2.3.4
cdn.example.com # 域名
192.168.1.1 # IP
```

#### 方式二：远程获取 🔗

1. 点击 **"🔗 远程获取"** 按钮切换模式
2. 在 URL 输入框中粘贴远程文件 URL
3. 支持多个 URL，用逗号分隔
4. 点击 **"📥 获取"** 按钮
5. 系统会自动获取、解析并去重

**远程获取示例 URL：**
```
https://raw.githubusercontent.com/rdone4425/node/refs/heads/main/cf_ips.txt
https://example.com/domains.txt
https://cdn.example.com/optimize-list.txt
```

**优点：**
- ✅ 自动去重
- ✅ 支持注释（# 开头的行会被忽略）
- ✅ 支持多个 URL
- ✅ 自动过滤空行
- ✅ 可与本地输入结合使用

### 第四步：配置其他选项

- **启用此配置**：勾选以启用该配置（默认启用）
- **配置范围**：选择全局或特定订阅应用

### 第五步：保存配置

1. 点击 **"保存配置"** 按钮
2. 系统会验证配置内容
3. 成功后会显示提示信息并返回列表

## 🎨 UI 界面说明

### 优选配置卡片

每个优选配置以卡片形式显示，包含：

- **状态图标**：
  - 🌐 域名配置
  - 📍 IP配置
  - 🔗 混合配置
  - 🔒 禁用状态

- **配置信息**：
  - 配置名称
  - 配置描述
  - 配置类型标签
  - 项目数量统计
  - 前3项的预览（更多项会显示省略号）

- **数据来源**（如果从 URL 获取）：
  - 🔗 数据来源标签
  - 显示源 URL（最多显示2个）
  - 多个源时显示省略号

- **全局标签**：
  - 🌍 表示该配置为全局配置

- **操作按钮**：
  - ✏️ 编辑
  - 🔄 刷新（仅在有源 URL 时显示）
  - 🗑️ 删除

### 启用/禁用开关

点击卡片右上角的开关可以快速启用/禁用配置，无需进入编辑模态框。

### 刷新功能 🔄

如果优选配置是从远程 URL 获取的，卡片上会显示 **"🔄 刷新"** 按钮：

1. 点击刷新按钮
2. 系统会从原始 URL 重新获取最新的优选项列表
3. 新项会自动去重并更新配置
4. 更新时间戳会被改写

## 💡 使用场景

### 场景1：加速CDN访问
创建一个名为 "CDN加速" 的域名优选配置，添加多个CDN节点：
```
cdn1.provider.com
cdn2.provider.com
cdn3.provider.com
```

### 场景2：指定IP访问
创建一个名为 "国内IP" 的IP优选配置：
```
10.0.0.1
10.0.0.2
10.0.0.3
```

### 场景3：特定订阅优选
为某个特定的订阅创建优选配置，只在该订阅转换时生效。

## ⚙️ 配置数据存储

所有优选配置都会自动保存到系统存储中（KV 或 D1 数据库），支持：
- ✅ 自动保存
- ✅ 持久化存储
- ✅ 跨会话保持
- ✅ 备份恢复

## 🔍 常见问题

### Q1：优选配置什么时候生效？
> A：当前界面仅用于配置管理。实际生效需要在转换节点时应用这些配置。后续会在节点转换引擎中集成此功能。

### Q2：能否删除已启用的配置？
> A：可以。系统会先禁用配置，然后删除。

### Q3：如何批量导入优选项？
> A：有两种方式：
> - **手动输入**：在优选项列表文本框中粘贴，每行一条即可。支持自动去重。
> - **远程获取**：使用 URL 方式直接从远程文件获取，系统会自动去重和过滤。

### Q4：注释行会被保存吗？
> A：不会。系统会自动过滤注释行（以 # 开头），只保存有效的项目。

### Q5：如何更新从 URL 获取的优选项？
> A：如果配置有源 URL，卡片上会显示 **"🔄 刷新"** 按钮，点击即可从原始 URL 重新获取最新的优选项列表。

### Q6：多个 URL 中如果有重复项怎么处理？
> A：系统会自动检测并去重，只保留一条。

### Q7：如果 URL 返回的内容格式不对怎么办？
> A：系统会按行解析，自动过滤空行和注释。只要内容是逐行显示，就能正确解析。

### Q8：支持哪些 URL 格式？
> A：只要能通过 HTTP/HTTPS 访问并返回文本内容的任何 URL 都支持，包括：
> - GitHub Raw 链接
> - 自托管服务器
> - 任何公开的文本文件 URL

### Q9：远程获取时出现错误怎么办？
> A：系统会显示具体的错误信息。常见原因：
> - URL 无效或不存在
> - 网络连接问题
> - 服务器返回错误状态码
> - 文件权限问题

## 📊 配置统计

在列表顶部会显示：
- 总配置数量
- 启用中的配置数量

## 🚀 后续集成

这个优选管理功能预计会与以下模块集成：
- [ ] 节点转换引擎
- [ ] 订阅处理流程
- [ ] 批量优选应用
- [ ] 优选效果统计

## 📝 技术实现

### 前端技术栈
- **Vue 3 Composition API**
- **TypeScript**
- **Pinia 状态管理**
- **Tailwind CSS 样式**

### 数据结构
```typescript
interface OptimalConfig {
    id: string;                    // 唯一标识符
    name: string;                  // 配置名称
    description?: string;          // 配置描述
    items: string[];               // 优选项列表
    sourceUrls?: string[];         // 优选项来源 URL（用于更新）
    type: 'domain' | 'ip' | 'mixed'; // 配置类型
    enabled: boolean;              // 是否启用
    createdAt: number;             // 创建时间戳
    updatedAt: number;             // 更新时间戳
    isGlobal: boolean;             // 是否为全局配置
    subscriptionIds?: string[];    // 关联的订阅ID
}
```

## 🎓 相关文件

| 文件路径 | 说明 |
|---------|------|
| `src/features/optimize/OptimizeTab.vue` | 主标签页组件 |
| `src/features/optimize/components/OptimizeCard.vue` | 配置卡片组件 |
| `src/features/optimize/components/OptimizeEditModal.vue` | 编辑模态框（支持远程获取） |
| `src/types/index.ts` | 类型定义（OptimalConfig） |
| `src/stores/data.ts` | Pinia 状态管理扩展 |

## 🔧 关键方法

### useDataStore 中的方法

| 方法名 | 说明 |
|--------|------|
| `addOptimalConfig(config)` | 添加新的优选配置 |
| `updateOptimalConfig(config)` | 更新优选配置 |
| `deleteOptimalConfig(id)` | 删除指定配置 |
| `deleteAllOptimalConfigs()` | 清空所有配置 |
| `refreshOptimalConfigFromUrls(id)` | 从源 URL 刷新配置项 |

---

**更新时间**: 2026-02-23
**版本**: 2.0.0 (支持远程获取和刷新)

## 功能更新历史

### v2.0.0 (2026-02-23)
- ✅ 新增远程获取功能（支持从 URL 获取优选项）
- ✅ 新增刷新功能（重新从源 URL 获取最新优选项）
- ✅ 支持多 URL 并发获取
- ✅ 自动去重和格式验证
- ✅ 卡片显示数据来源信息

### v1.0.0 (2026-02-23)
- ✅ 基础优选配置管理
- ✅ 手动输入优选项
- ✅ 启用/禁用切换
